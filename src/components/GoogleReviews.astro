---
// Google Reviews - pobiera opinie z API
const REVIEWS_API = 'https://ed7tekpjz6.execute-api.eu-central-1.amazonaws.com/prod/reviews';
const PLACE_ID = 'ChIJFcfLk-s1A0cRg5OfN4oSskU';

interface Review {
  author_name: string;
  profile_photo_url?: string;
  rating: number;
  text: string;
  time: number;
}

interface ReviewsData {
  reviews: Review[];
  rating: number;
  total: number;
}

let data: ReviewsData | null = null;
let error = false;

try {
  const response = await fetch(`${REVIEWS_API}?placeId=${PLACE_ID}`);
  if (response.ok) {
    data = await response.json();
  } else {
    error = true;
  }
} catch (e) {
  error = true;
}
---

<div class="google-reviews">
  {error ? (
    <div class="google-reviews__error">
      <p>Nie udało się pobrać opinii</p>
      <p class="google-reviews__error-sub">Spróbuj odświeżyć stronę</p>
    </div>
  ) : data ? (
    <>
      <div class="google-reviews__summary">
        <div class="google-reviews__score">{data.rating.toFixed(1)}</div>
        <div class="google-reviews__stars">
          {[1,2,3,4,5].map(i => (
            <svg viewBox="0 0 24 24" class={i <= Math.round(data!.rating) ? 'filled' : ''}>
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
          ))}
        </div>
        <div class="google-reviews__count">Na podstawie {data.total} opinii Google</div>
      </div>
      
      <div class="google-reviews__grid">
        {data.reviews.map(review => (
          <div class="review-card">
            <div class="review-card__header">
              {review.profile_photo_url ? (
                <img src={review.profile_photo_url} alt="" class="review-card__avatar" referrerpolicy="no-referrer" />
              ) : (
                <div class="review-card__avatar review-card__avatar--placeholder">
                  <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                </div>
              )}
              <div class="review-card__info">
                <div class="review-card__name">{review.author_name}</div>
                <div class="review-card__stars">
                  {[1,2,3,4,5].map(i => (
                    <svg viewBox="0 0 24 24" class={i <= review.rating ? 'filled' : ''}>
                      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                  ))}
                </div>
              </div>
            </div>
            <p class="review-card__text" data-full={review.text}>
              {review.text.length > 200 ? review.text.slice(0, 200) + '...' : review.text}
              {review.text.length > 200 && (
                <button class="review-card__more">Pokaż więcej</button>
              )}
            </p>
            
          </div>
        ))}
      </div>
    </>
  ) : (
    <div class="google-reviews__loading">
      <div class="google-reviews__spinner"></div>
    </div>
  )}
</div>

<style>
  .google-reviews__error {
    text-align: center;
    padding: 2rem;
  }
  .google-reviews__error p { color: #ef4444; }
  .google-reviews__error-sub { color: #666; margin-top: 0.5rem; }
  
  .google-reviews__loading {
    display: flex;
    justify-content: center;
    padding: 3rem;
  }
  .google-reviews__spinner {
    width: 48px;
    height: 48px;
    border: 3px solid #e5e0d8;
    border-top-color: var(--color-accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  
  .google-reviews__summary {
    text-align: center;
    margin-bottom: 2rem;
  }
  .google-reviews__score {
    font-size: 3rem;
    font-weight: 700;
    color: var(--color-accent);
  }
  .google-reviews__stars {
    display: flex;
    justify-content: center;
    gap: 4px;
    margin: 0.5rem 0;
  }
  .google-reviews__stars svg {
    width: 24px;
    height: 24px;
    fill: #d1d5db;
  }
  .google-reviews__stars svg.filled {
    fill: var(--color-accent);
  }
  .google-reviews__count {
    color: #666;
  }
  
  .google-reviews__grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
  }
  
  .review-card {
    padding: 1.5rem;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.06);
    border: 1px solid #e5e0d8;
    transition: box-shadow 0.3s ease;
  }
  .review-card:hover {
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
  }
  .review-card__header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }
  .review-card__avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
  }
  .review-card__avatar--placeholder {
    background: #f3f4f6;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .review-card__avatar--placeholder svg {
    width: 20px;
    height: 20px;
    fill: #9ca3af;
  }
  .review-card__name {
    font-weight: 600;
    font-size: 0.9375rem;
  }
  .review-card__stars {
    display: flex;
    gap: 2px;
  }
  .review-card__stars svg {
    width: 14px;
    height: 14px;
    fill: #d1d5db;
  }
  .review-card__stars svg.filled {
    fill: var(--color-accent);
  }
  .review-card__text {
    color: #666;
    font-size: 0.9375rem;
    line-height: 1.6;
    margin: 0;
  }
  .review-card__more {
    background: none;
    border: none;
    color: var(--color-accent);
    cursor: pointer;
    font-size: 0.9375rem;
    margin-left: 4px;
  }
  .review-card__more:hover {
    text-decoration: underline;
  }
  .review-card__date {
    margin-top: 0.75rem;
    font-size: 0.8125rem;
    color: #9ca3af;
  }
</style>

<script>
  document.querySelectorAll('.review-card__more').forEach(btn => {
    btn.addEventListener('click', () => {
      const textEl = btn.parentElement as HTMLElement;
      const fullText = textEl.dataset.full;
      if (fullText) {
        textEl.textContent = fullText;
      }
    });
  });
</script>